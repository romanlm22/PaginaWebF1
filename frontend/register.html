<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tienda F1 — Registro</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="styles.css" />
  <style>
    .auth-card{max-width:460px;margin:48px auto}
    .icon-eye{cursor:pointer; user-select:none}
  </style>
</head>
<body class="page">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">Tienda F1</a>
      <div class="ms-auto d-flex align-items-center gap-2">
        <a href="cart.html">🛒 <span id="cartCount" class="badge text-bg-primary rounded-pill">0</span></a>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="container">
    <div class="card shadow-sm auth-card">
      <div class="card-body">
        <h3 class="mb-3">Crear cuenta</h3>

        <form id="registerForm" class="d-grid gap-3" novalidate>
          <div>
            <label for="email" class="form-label">Correo</label>
            <input class="form-control" type="email" id="email" placeholder="ej: user@mail.com" required />
            <div class="invalid-feedback">Ingresá un correo válido.</div>
          </div>

          <div>
            <label for="password" class="form-label d-flex justify-content-between">
              <span>Contraseña</span>
              <small class="text-muted">mín. 8 caracteres</small>
            </label>
            <div class="input-group">
              <input class="form-control" type="password" id="password" minlength="8" required />
              <button class="btn btn-outline-secondary" type="button" id="togglePass" aria-label="Mostrar/ocultar">
                <span class="icon-eye">👁️</span>
              </button>
            </div>
            <div class="invalid-feedback">Mínimo 8 caracteres.</div>
          </div>

          <div>
            <label for="password2" class="form-label">Repetir contraseña</label>
            <input class="form-control" type="password" id="password2" minlength="8" required />
            <div class="invalid-feedback">Las contraseñas no coinciden.</div>
          </div>

          <button id="btnSubmit" class="btn btn-success" type="submit">
            <span class="spinner-border spinner-border-sm me-2 d-none" id="sp"></span>
            Registrarse
          </button>

          <div class="text-center">
            <a href="login.html">Ya tengo cuenta</a>
          </div>

          <div id="msg" class="alert d-none mt-2" role="alert"></div>
        </form>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer>
    <div class="container d-flex justify-content-between align-items-center">
      <div>© Tienda F1</div>
      <div>
        <a href="https://instagram.com/" target="_blank"><img class="icon" src="https://cdn-icons-png.flaticon.com/512/2111/2111463.png" alt="IG" /></a>
        <a href="https://twitter.com/" target="_blank"><img class="icon" src="https://cdn-icons-png.flaticon.com/512/733/733579.png" alt="X" /></a>
        <a href="https://youtube.com/" target="_blank"><img class="icon" src="https://cdn-icons-png.flaticon.com/512/1384/1384060.png" alt="YT" /></a>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="common.js"></script>
  <script>
    (function () {
      const { loadMe, saveCart, register } = window.__APP__;
      loadMe(); saveCart();

      const form = document.getElementById('registerForm');
      const email = document.getElementById('email');
      const pass  = document.getElementById('password');
      const pass2 = document.getElementById('password2');
      const btn   = document.getElementById('btnSubmit');
      const sp    = document.getElementById('sp');
      const msg   = document.getElementById('msg');

      // Mostrar/ocultar contraseña
      document.getElementById('togglePass').onclick = () => {
        const t = pass.type === 'password' ? 'text' : 'password';
        pass.type = t; pass2.type = t;
      };

      function showMsg(text, type = 'success') {
        msg.textContent = text;
        msg.className = 'alert alert-' + type;
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        msg.className = 'alert d-none';

        // Validaciones básicas
        let valid = true;
        if (!email.checkValidity()) { email.classList.add('is-invalid'); valid = false; } else email.classList.remove('is-invalid');
        if (!pass.checkValidity())  { pass.classList.add('is-invalid');   valid = false; } else pass.classList.remove('is-invalid');
        if (pass.value !== pass2.value) { pass2.classList.add('is-invalid'); valid = false; } else pass2.classList.remove('is-invalid');
        if (!valid) return;

        try {
          btn.disabled = true; sp.classList.remove('d-none');

          const user = await register(email.value.trim(), pass.value);
          showMsg('Cuenta creada: ' + user.email, 'success');

          // Redirección segura
          setTimeout(() => { window.location.replace('index.html'); }, 400);
        } catch (err) {
          console.error(err);
          showMsg(err.message || 'No se pudo registrar', 'danger');
        } finally {
          btn.disabled = false; sp.classList.add('d-none');
        }
      });
    })();
  </script>
</body>
</html>
